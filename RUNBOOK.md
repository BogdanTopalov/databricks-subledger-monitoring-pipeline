# Subledger Monitoring - Incident Runbook

## Overview
This runbook describes how to detect, investigate, and resolve incidents
generated by the subledger monitoring checks in Databricks.

Scope:
- Daily subledger aggregation
- Data quality validation
- Reconciliation vs expected totals (mock GL)


## Incident Categories

### DATA_QUALITY
Issues caused by malformed or invalid source data.

Examples:
- Missing transaction_id
- Negative transaction amounts

### RECONCILIATION
Mismatches between subledger totals and expected (GL) totals.

## Incident: missing_transaction_id

**Severity:** HIGH  
**Category:** DATA_QUALITY  

### Detection
Triggered when one or more rows in `transactions_raw` have NULL `transaction_id`.

### Investigation
```sql
SELECT *
FROM demo_subledger_monitoring.transactions_raw
WHERE transaction_id IS NULL
  AND posting_date = <posting_date>;
```

### Root Cause
Upstream source sent incomplete records or ingestion mapping issue.

### Resolution
- Notify upstream data owner.
- Reprocess corrected data if available.

### Escalation
Escalate to data engineering if issue persists more than one business day.


## Incident: negative_amounts

**Severity:** MEDIUM  
**Category:** DATA_QUALITY  

### Investigation
```sql
SELECT *
FROM demo_subledger_monitoring.transactions_raw
WHERE amount < 0
  AND posting_date = <posting_date>;
```

### Resolution
- Validate if negative amounts are expected (refunds, reversals).
- If unexpected, block posting and notify finance.

## Incident: reconciliation_mismatch

**Severity:** HIGH  
**Category:** RECONCILIATION  

### Investigation
```sql
SELECT
  s.posting_date,
  s.account_id,
  s.currency,
  s.total_amount,
  e.expected_total
FROM demo_subledger_monitoring.subledger_daily s
JOIN demo_subledger_monitoring.expected_daily_totals e
  ON s.posting_date = e.posting_date
 AND s.account_id = e.account_id
 AND s.currency = e.currency
WHERE s.total_amount <> e.expected_total;
```

### Root Cause
- Missing or duplicate transactions
- Incorrect aggregation logic
- Late-arriving data

### Resolution
- Re-run aggregation after data correction.
- Align cut-off logic with GL if timing-related.

### Escalation
Immediate escalation to engineering and finance.


## Operational Notes
- All checks run daily after ingestion completes.
- Incidents are logged in `incident_log` with status OPEN.
- Resolution updates status to RESOLVED.
